<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAzP8AAAD//wD/AAAAAKX/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABEREREREREAAAAAAAAAAABVUAMABEQCAFBVAwAABAIAUAUDAAAEAgBQBQMAAAQCAFVVAzMERAIAUAUDAAQAAgBQBQMABAACAFBVAwAEAAIAVVADMwREAgAAAAAAAAAAABEREREREREAAAAAAAAAAAAAAAAAAAAADAAwAAgAEAAP//AACNxQAApfUAALX1AAC19QAAhEUAALXdAAC13QAApd0AAIxFAAD//wAAgAEAAMADAADgBwAA" type="image/x-icon">
    <title>Buriram Shelter Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 20px; }
    </style>
  </head>
  <body class="p-6">
    <!-- Header -->
    <header class="mb-8 flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-sm border-l-4 border-teal-500">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Buriram Provincial Shelter Environmental Health Dashboard (SEhRT)</h1>
            <p class="text-gray-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå</p>
        </div>
        <div class="mt-4 md:mt-0 text-right">
            <p class="text-sm text-gray-500">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
            <p class="font-bold text-teal-600" id="lastUpdate">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>
    </header>

    <!-- KPI Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="card border-l-4 border-blue-500">
            <p class="text-gray-500 text-sm">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <h2 class="text-3xl font-bold text-gray-800 mt-2" id="totalShelters">0</h2>
            <p class="text-xs text-gray-400 mt-1">‡πÅ‡∏´‡πà‡∏á (‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ <span id="percentShelters">0</span>)</p>
        </div>
        <div class="card border-l-4 border-green-500">
            <p class="text-gray-500 text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
            <h2 class="text-3xl font-bold text-green-600 mt-2" id="activeShelters">0</h2>
            <p class="text-xs text-gray-400 mt-1">‡πÅ‡∏´‡πà‡∏á</p>
        </div>
        <div class="card border-l-4 border-orange-500">
            <p class="text-gray-500 text-sm">‡∏ú‡∏π‡πâ‡∏≠‡∏û‡∏¢‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
            <h2 class="text-3xl font-bold text-orange-600 mt-2" id="currentPeople">0</h2>
            <p class="text-xs text-gray-400 mt-1">‡∏Ñ‡∏ô (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="totalCapacity">0</span>)</p>
        </div>
        <div class="card border-l-4 border-red-500">
            <p class="text-gray-500 text-sm">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏£‡∏≤‡∏∞‡∏ö‡∏≤‡∏á‡∏£‡∏ß‡∏°</p>
            <h2 class="text-3xl font-bold text-red-600 mt-2" id="vulnerableTotal">0</h2>
            <p class="text-xs text-gray-400 mt-1">‡∏Ñ‡∏ô</p>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Chart: Status -->
        <div class="card lg:col-span-1">
            <h3 class="font-bold text-gray-700 mb-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
            <div class="relative h-64">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        
        <!-- Chart: Vulnerable Groups -->
        <div class="card lg:col-span-2">
            <h3 class="font-bold text-gray-700 mb-4">‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏£‡∏≤‡∏∞‡∏ö‡∏≤‡∏á (‡∏Ñ‡∏ô)</h3>
            <div class="relative h-64">
                <canvas id="vulnerableChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
         <!-- Chart: District -->
         <div class="card">
            <h3 class="font-bold text-gray-700 mb-4">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡∏£‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</h3>
            <div class="relative h-64">
                <canvas id="districtChart"></canvas>
            </div>
        </div>

        <!-- Sanitation Stats -->
        <div class="card">
            <h3 class="font-bold text-gray-700 mb-4">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• (‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°)</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-blue-800 font-semibold">üöΩ ‡∏°‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏´‡πâ‡∏≠‡∏á‡∏™‡πâ‡∏ß‡∏° ‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏è‡∏¥‡∏Å‡∏π‡∏•</p>
                    <p class="text-2xl font-bold text-blue-600" id="toiletCount">0</p>
                    <p class="text-xs text-gray-500">‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå</p>
                </div>
                <div class="bg-teal-50 p-4 rounded-lg">
                    <p class="text-sm text-teal-800 font-semibold">üóëÔ∏è ‡∏°‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏°‡∏π‡∏•‡∏ù‡∏≠‡∏¢ (‡∏Ç‡∏¢‡∏∞)</p>
                    <p class="text-lg font-bold text-teal-600" id="wastePass">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    <p class="text-xs text-gray-500">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå</p>
                </div>
                <div class="bg-indigo-50 p-4 rounded-lg">
                    <p class="text-sm text-indigo-800 font-semibold">üíß ‡∏°‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏≠‡∏∏‡∏õ‡πÇ‡∏†‡∏Ñ/‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ</p>
                    <p class="text-lg font-bold text-indigo-600" id="waterPass">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    <p class="text-xs text-gray-500">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå</p>
                </div>
                 <div class="bg-pink-50 p-4 rounded-lg">
                    <p class="text-sm text-pink-800 font-semibold">üçΩÔ∏è ‡∏°‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
                    <p class="text-lg font-bold text-pink-600" id="foodPass">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    <p class="text-xs text-gray-500">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card overflow-hidden">
        <h3 class="font-bold text-gray-700 mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th class="px-6 py-3">‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå</th>
                        <th class="px-6 py-3">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</th>
                        <th class="px-6 py-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th class="px-6 py-3 text-center">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ (‡∏Ñ‡∏ô)</th>
                        <th class="px-6 py-3 text-center">‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Ñ‡∏ô)</th>
                        <th class="px-6 py-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î</th>
                    </tr>
                </thead>
                <tbody id="shelterTableBody">
                    <!-- Data will be injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- Data Processing Logic ---
        function processData(data) {
            let stats = {
                totalShelters: data.length,
                activeShelters: 0,
                currentPeople: 0,
                totalCapacity: 0,
                vulnerable: {
                    total: 0,
                    disabled: 0,
                    elderly: 0,
                    bedridden: 0,
                    pregnant: 0,
                    kids: 0,
                    dialysis: 0,
                    psych: 0
                },
                districts: {},
                sanitation: {
                    toilets: 0,
                    wastePass: 0,
                    waterPass: 0,
                    foodPass: 0
                }
            };

            let activeList = [];

            data.forEach(row => {
                // Mapping columns based on user snippet
                // 4: District, 5: Name, 7: Status, 11: Capacity, 12: Occupancy
                // 14: Disabled, 15: Elderly, 16: Bedridden, 17: Pregnant, 18: Kids, 19: Dialysis, 20: Psych
                
                let district = row[4];
                let status = row[7];
                let capacity = parseInt(row[11]) || 0;
                let occupancy = parseInt(row[12]) || 0;
                
                // Vulnerable
                let disabled = parseInt(row[14]) || 0;
                let elderly = parseInt(row[15]) || 0;
                let bedridden = parseInt(row[16]) || 0;
                let pregnant = parseInt(row[17]) || 0;
                let kids = parseInt(row[18]) || 0;
                let dialysis = parseInt(row[19]) || 0;
                let psych = parseInt(row[20]) || 0;

                // Sanitation (Approximate columns based on snippet)
                // 26: Toilet Count
                // 35: Separate Waste (Example check)
                let toilets = parseInt(row[26]) || 0;
                
                // Aggregate
                stats.totalCapacity += capacity;
                stats.currentPeople += occupancy;
                stats.sanitation.toilets += toilets;

                // Status Check
                if (status.includes("‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£")) {
                    stats.activeShelters++;
                    activeList.push(row);
                }

                // Vulnerable Sum
                stats.vulnerable.total += (disabled + elderly + bedridden + pregnant + kids + dialysis + psych);
                stats.vulnerable.disabled += disabled;
                stats.vulnerable.elderly += elderly;
                stats.vulnerable.bedridden += bedridden;
                stats.vulnerable.pregnant += pregnant;
                stats.vulnerable.kids += kids;
                stats.vulnerable.dialysis += dialysis;
                stats.vulnerable.psych += psych;

                // District Count
                if (stats.districts[district]) {
                    stats.districts[district]++;
                } else {
                    stats.districts[district] = 1;
                }
                
                // Sanitation simplistic check (Counting '‡∏ú‡πà‡∏≤‡∏ô/‡∏°‡∏µ' in specific columns would go here)
                // Just mocking logic for visuals based on sample row data structure
                if (row[35] && row[35].includes("‡∏ú‡πà‡∏≤‡∏ô/‡∏°‡∏µ")) stats.sanitation.wastePass++;
                if (row[46] && row[46].includes("‡∏ú‡πà‡∏≤‡∏ô/‡∏°‡∏µ")) stats.sanitation.foodPass++; 
                if (row[23] && row[23].includes("‡∏ú‡πà‡∏≤‡∏ô/‡∏°‡∏µ")) stats.sanitation.waterPass++; // Dimension 1.3
            });

            return { stats, activeList };
        }

        // --- Rendering Logic ---
        async function initDashboard() {
          let url = 'https://script.google.com/macros/s/AKfycbwAY3s3VpDRfpo6otgiONAdKnPtR6VamhK5o8bOWI7p4uhsxBpE2BGdlBKv9EeNPtm1/exec';
          let response = await fetch(url+"?data=GET");
          let json = await response.json();
          let data = json.data;

          // ‡∏™‡πà‡∏á data ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
          let { stats, activeList } = processData(data);

          // Update Header Date
          document.getElementById('lastUpdate').innerText = new Date().toLocaleDateString('th-TH');

          // Update KPI Cards
          document.getElementById('totalShelters').innerText = stats.totalShelters + '/183';
          document.getElementById('percentShelters').innerText = Number((stats.totalShelters / 183) * 100).toFixed(2);
          document.getElementById('activeShelters').innerText = stats.activeShelters;
          document.getElementById('currentPeople').innerText = stats.currentPeople.toLocaleString();
          document.getElementById('totalCapacity').innerText = stats.totalCapacity.toLocaleString();
          document.getElementById('vulnerableTotal').innerText = stats.vulnerable.total.toLocaleString();
          
          // Update Sanitation
          document.getElementById('toiletCount').innerText = stats.sanitation.toilets;
          document.getElementById('wastePass').innerText = `${stats.sanitation.wastePass}/${stats.totalShelters}`;
          document.getElementById('waterPass').innerText = `${stats.sanitation.waterPass}/${stats.totalShelters}`;
          document.getElementById('foodPass').innerText = `${stats.sanitation.foodPass}/${stats.totalShelters}`;

          // Chart 1: Status
          new Chart(document.getElementById('statusChart'), {
              type: 'doughnut',
              data: {
                  labels: ['‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', '‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£'],
                  datasets: [{
                      data: [stats.activeShelters, stats.totalShelters - stats.activeShelters],
                      backgroundColor: ['#10b981', '#9ca3af'],
                  }]
              },
              options: { responsive: true, maintainAspectRatio: false }
          });

          // Chart 2: Vulnerable Groups
          new Chart(document.getElementById('vulnerableChart'), {
              type: 'bar',
              data: {
                  labels: ['‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏Å‡∏≤‡∏£', '‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏', '‡∏ï‡∏¥‡∏î‡πÄ‡∏ï‡∏µ‡∏¢‡∏á', '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå', '‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å', '‡∏ü‡∏≠‡∏Å‡πÑ‡∏ï', '‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä'],
                  datasets: [{
                      label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô',
                      data: [
                          stats.vulnerable.disabled,
                          stats.vulnerable.elderly,
                          stats.vulnerable.bedridden,
                          stats.vulnerable.pregnant,
                          stats.vulnerable.kids,
                          stats.vulnerable.dialysis,
                          stats.vulnerable.psych
                      ],
                      backgroundColor: '#f87171',
                      borderRadius: 5
                  }]
              },
              options: { 
                  responsive: true, 
                  maintainAspectRatio: false,
                  plugins: { legend: { display: false } }
              }
          });

          // Chart 3: District Distribution
          new Chart(document.getElementById('districtChart'), {
              type: 'bar',
              data: {
                  labels: Object.keys(stats.districts),
                  datasets: [{
                      label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå',
                      data: Object.values(stats.districts),
                      backgroundColor: '#3b82f6',
                      borderRadius: 5
                  }]
              },
              options: { 
                  responsive: true, 
                  maintainAspectRatio: false,
                  indexAxis: 'y'
              }
          });

          // Populate Table
          let tableBody = document.getElementById('shelterTableBody');
          activeList.forEach(row => {
              let tr = document.createElement('tr');
              tr.className = "bg-white border-b hover:bg-gray-50";
              
              // Customize status badge
              let statusColor = row[7].includes("‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£") ? "text-green-600 bg-green-100" : "text-gray-600 bg-gray-100";
              
              tr.innerHTML = `
                  <td class="px-6 py-4 font-medium text-gray-900">${row[5]}</td>
                  <td class="px-6 py-4">${row[4]}</td>
                  <td class="px-6 py-4"><span class="${statusColor} py-1 px-3 rounded-full text-xs font-bold">${row[7]}</span></td>
                  <td class="px-6 py-4 text-center">${row[11]}</td>
                  <td class="px-6 py-4 text-center font-bold text-gray-800">${row[12]}</td>
                  <td class="px-6 py-4 text-gray-500 text-xs">${row[8]}</td>
              `;
              tableBody.appendChild(tr);
          });
        }

        // Run
        window.onload = initDashboard();

    </script>
  </body>
</html>
